<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BibTeX Grabber</title>
  <style>
    :root {
      --bg: #1a1a2e;
      --surface: #16213e;
      --surface2: #0f3460;
      --accent: #e94560;
      --accent2: #533483;
      --label-color: #7c4dff;
      --label-bg: #2d1f5e;
      --label-border: #4a2fa0;
      --label-selected: #7c4dff;
      --text: #e0e0e0;
      --text-muted: #8892a4;
      --success: #4caf50;
      --border: #2d3748;
      --tag-bg: #1e3a5f;
      --tag-hover: #2a4a7f;
      --radius: 6px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      width: 480px;
      min-height: 200px;
      max-height: 720px;
      overflow-y: auto;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px 10px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
    }
    .header-icon {
      width: 28px;
      height: 28px;
      background: var(--accent);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .header h1 {
      font-size: 14px;
      font-weight: 700;
      color: #fff;
      flex: 1;
    }
    .header .subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ‚îÄ‚îÄ Status / Loading ‚îÄ‚îÄ */
    #status-bar {
      padding: 8px 14px;
      font-size: 12px;
      color: var(--text-muted);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .spinner {
      width: 12px;
      height: 12px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Metadata fields ‚îÄ‚îÄ */
    #meta-section {
      padding: 10px 14px;
      display: none;
    }
    .section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section-title .section-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 1px 6px;
      border-radius: 10px;
      text-transform: none;
      letter-spacing: 0;
    }
    .badge-keyword {
      background: var(--tag-bg);
      color: #a8c4e0;
      border: 1px solid #2d4a6e;
    }
    .badge-label {
      background: var(--label-bg);
      color: #b39dff;
      border: 1px solid var(--label-border);
    }
    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .field-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }
    .field-grid .full { grid-column: 1 / -1; }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .field label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }
    .field input, .field textarea, .field select {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 12px;
      padding: 4px 7px;
      outline: none;
      transition: border-color 0.15s;
      font-family: inherit;
      width: 100%;
    }
    .field input:focus, .field textarea:focus, .field select:focus {
      border-color: var(--accent);
    }
    .field textarea {
      resize: vertical;
      min-height: 54px;
      max-height: 100px;
    }
    .field select option { background: var(--surface2); }

    /* ‚îÄ‚îÄ Shared tag/label pill styles ‚îÄ‚îÄ */
    .pills-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 6px;
      min-height: 28px;
    }

    .pill {
      padding: 3px 9px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.15s;
      user-select: none;
    }

    /* Keyword pills (blue tones) */
    .pill.kw-suggested {
      background: var(--tag-bg);
      color: #a8c4e0;
      border-color: #2d4a6e;
    }
    .pill.kw-suggested:hover { background: var(--tag-hover); }
    .pill.kw-selected {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .pill.kw-selected:hover { opacity: 0.85; }

    /* Label pills (purple tones) */
    .pill.lbl-suggested {
      background: var(--label-bg);
      color: #b39dff;
      border-color: var(--label-border);
    }
    .pill.lbl-suggested:hover { background: #3d2a80; }
    .pill.lbl-selected {
      background: var(--label-color);
      color: #fff;
      border-color: var(--label-color);
    }
    .pill.lbl-selected:hover { opacity: 0.85; }

    .pill-input-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    .pill-input-row input {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 12px;
      padding: 4px 8px;
      outline: none;
    }
    .pill-input-row input:focus { border-color: var(--accent); }
    .pill-input-row input::placeholder { color: var(--text-muted); }
    .pill-input-row input.label-input:focus { border-color: var(--label-color); }

    .btn-small {
      padding: 4px 10px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      font-size: 11px;
      cursor: pointer;
      transition: background 0.15s;
      white-space: nowrap;
    }
    .btn-small:hover { background: var(--accent); border-color: var(--accent); }
    .btn-small.label-btn:hover { background: var(--label-color); border-color: var(--label-color); }

    /* ‚îÄ‚îÄ Tags section ‚îÄ‚îÄ */
    #tags-section {
      padding: 8px 14px;
      display: none;
    }

    /* ‚îÄ‚îÄ Labels section ‚îÄ‚îÄ */
    #labels-section {
      padding: 8px 14px;
      display: none;
    }

    .label-note {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 5px;
      font-style: italic;
    }

    /* ‚îÄ‚îÄ BibTeX output ‚îÄ‚îÄ */
    #bibtex-section {
      padding: 8px 14px;
      display: none;
    }

    #bibtex-output {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 10px;
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 11px;
      line-height: 1.55;
      color: #c9d1d9;
      white-space: pre;
      overflow-x: auto;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 6px;
    }

    /* Syntax highlighting */
    .bib-type    { color: #ff7b72; }
    .bib-key     { color: #79c0ff; }
    .bib-field   { color: #d2a8ff; }
    .bib-value   { color: #a5d6ff; }
    .bib-label-val { color: #c9a7ff; }

    /* ‚îÄ‚îÄ Action buttons ‚îÄ‚îÄ */
    #actions {
      padding: 10px 14px 14px;
      display: none;
      gap: 8px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: var(--radius);
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      flex: 1;
    }
    .btn-primary:hover { opacity: 0.88; }
    .btn-secondary {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--tag-hover); border-color: var(--accent2); }
    .btn-success {
      background: var(--success);
      color: #fff;
    }

    /* ‚îÄ‚îÄ Error state ‚îÄ‚îÄ */
    #error-section {
      padding: 14px;
      display: none;
      text-align: center;
      color: var(--accent);
      font-size: 13px;
    }
    #error-section .error-detail {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* ‚îÄ‚îÄ Divider ‚îÄ‚îÄ */
    .divider {
      height: 1px;
      background: var(--border);
      margin: 6px 14px;
    }

    /* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent2); }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <div class="header-icon">üìÑ</div>
    <div>
      <h1>BibTeX Grabber</h1>
      <div class="subtitle">Extract ‚Üí Tag ‚Üí Copy</div>
    </div>
  </div>

  <!-- Loading / status -->
  <div id="status-bar">
    <div class="spinner" id="spinner"></div>
    <span id="status-text">Extracting metadata‚Ä¶</span>
  </div>

  <!-- Error -->
  <div id="error-section">
    <div>‚ö†Ô∏è Could not extract metadata</div>
    <div class="error-detail" id="error-detail"></div>
  </div>

  <!-- Metadata edit section -->
  <div id="meta-section">
    <div class="section-title">Metadata</div>
    <div class="field-grid">
      <div class="field">
        <label>Entry Type</label>
        <select id="f-type">
          <option value="article">article</option>
          <option value="inproceedings">inproceedings</option>
          <option value="book">book</option>
          <option value="incollection">incollection</option>
          <option value="phdthesis">phdthesis</option>
          <option value="mastersthesis">mastersthesis</option>
          <option value="techreport">techreport</option>
          <option value="misc">misc</option>
          <option value="unpublished">unpublished</option>
        </select>
      </div>
      <div class="field">
        <label>Cite Key</label>
        <input type="text" id="f-key" placeholder="author2024title">
      </div>
      <div class="field full">
        <label>Title</label>
        <input type="text" id="f-title" placeholder="Paper title">
      </div>
      <div class="field full">
        <label>Author(s) ‚Äî separate with " and "</label>
        <input type="text" id="f-authors" placeholder="Smith, John and Doe, Jane">
      </div>
      <div class="field">
        <label>Year</label>
        <input type="text" id="f-year" placeholder="2024" maxlength="4">
      </div>
      <div class="field">
        <label>DOI</label>
        <input type="text" id="f-doi" placeholder="10.xxxx/xxxxx">
      </div>
      <div class="field">
        <label>Journal / Booktitle</label>
        <input type="text" id="f-venue" placeholder="Journal or conference name">
      </div>
      <div class="field">
        <label>Publisher</label>
        <input type="text" id="f-publisher" placeholder="Publisher">
      </div>
      <div class="field">
        <label>Volume</label>
        <input type="text" id="f-volume" placeholder="12">
      </div>
      <div class="field">
        <label>Issue / Number</label>
        <input type="text" id="f-number" placeholder="3">
      </div>
      <div class="field">
        <label>Pages</label>
        <input type="text" id="f-pages" placeholder="100--120">
      </div>
      <div class="field">
        <label>URL</label>
        <input type="text" id="f-url" placeholder="https://‚Ä¶">
      </div>
      <div class="field full">
        <label>Abstract</label>
        <textarea id="f-abstract" placeholder="Optional abstract‚Ä¶"></textarea>
      </div>
    </div>
  </div>

  <div class="divider" id="div-tags" style="display:none"></div>

  <!-- Keywords / Tags section -->
  <div id="tags-section">
    <div class="section-title">
      Keywords
      <span class="section-badge badge-keyword">‚Üí keywords field</span>
    </div>
    <div class="pills-container" id="tags-container"></div>
    <div class="pill-input-row">
      <input type="text" id="custom-tag-input" placeholder="Add keyword‚Ä¶">
      <button class="btn-small" id="add-tag-btn">+ Add</button>
    </div>
  </div>

  <div class="divider" id="div-labels" style="display:none"></div>

  <!-- Paperpile Labels section -->
  <div id="labels-section">
    <div class="section-title">
      Paperpile Labels
      <span class="section-badge badge-label">‚Üí note field</span>
    </div>
    <div class="pills-container" id="labels-container"></div>
    <div class="pill-input-row">
      <input type="text" id="custom-label-input" class="label-input" placeholder="Add label‚Ä¶">
      <button class="btn-small label-btn" id="add-label-btn">+ Add</button>
    </div>
    <div class="label-note">
      ‚ìò Paperpile has no BibTeX label import field. Labels are stored as
      <code style="color:#b39dff">note = {pp-labels: ‚Ä¶}</code> so you can
      batch-assign them after import using a script or search.
    </div>
  </div>

  <div class="divider" id="div-bibtex" style="display:none"></div>

  <!-- BibTeX output -->
  <div id="bibtex-section">
    <div class="section-title">BibTeX</div>
    <div id="bibtex-output"></div>
  </div>

  <!-- Actions -->
  <div id="actions" style="display:flex">
    <button class="btn btn-secondary" id="btn-refresh" title="Re-extract from page">‚Ü∫ Re-extract</button>
    <button class="btn btn-secondary" id="btn-generate" title="Regenerate BibTeX">‚öô Generate</button>
    <button class="btn btn-primary" id="btn-copy">üìã Copy BibTeX</button>
  </div>

  <script src="tags.js"></script>
  <script src="popup.js"></script>
</body>
</html>
